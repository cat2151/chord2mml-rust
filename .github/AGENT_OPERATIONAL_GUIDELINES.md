# AI Agent 運用ガイドライン

## 目的

このドキュメントは、AI Copilot Agent がこのリポジトリで作業する際の運用ルールを定義します。
PR #28 のような重大な誤り（動作している機能の削除）を防止するため、明確なガイドラインを設定します。

## PR #28 で発生した問題の分析

### 何が起きたか
- **問題**: CIでtree-sitterがwasm32-unknown-unknownターゲットにコンパイルできずエラー
- **Agent の対処**: `.github/workflows/deploy-pages.yml` を丸ごと削除
- **結果**: GitHub Pages へのデプロイ機能全体が失われた

### なぜ問題だったか
1. **指示違反**: copilot-instructions.md に「その場しのぎのフォールバック実装は禁止」と明記されていたにも関わらず無視
2. **代替案の未検討**: tree-sitter の代替実装、wasm32-wasi target、条件付きコンパイルなどの検討なし
3. **影響評価の欠如**: デプロイ機能全体が失われる影響を評価せず
4. **ユーザー相談なし**: アーキテクチャ上の重大な判断をユーザーに相談せず独断で実施

### 本来あるべきだった対処

#### オプション1: アーキテクチャ提案（推奨）
```markdown
## 問題: tree-sitter が WASM にコンパイルできない

### 根本原因
tree-sitter クレートは C ライブラリに依存し、wasm32-unknown-unknown ターゲットをサポートしていません。

### 解決策の選択肢

**A. wasm32-wasi ターゲットを使用**
- メリット: tree-sitter がそのまま使える
- デメリット: WASI ランタイムが必要（ブラウザでは追加の設定が必要）
- 工数: 1-2時間

**B. WASM 用に純 Rust パーサーを実装**
- メリット: wasm32-unknown-unknown で動作、依存なし
- デメリット: パーサーの二重実装・メンテナンス
- 工数: 4-8時間

**C. ネイティブ版のみ tree-sitter を使用、WASM 版は別実装**
- メリット: 各環境で最適な実装
- デメリット: コードパスが分岐、テストが複雑化
- 工数: 6-10時間

### 推奨案
オプション A (wasm32-wasi) を推奨します。ブラウザ対応には追加作業が必要ですが、
tree-sitter の機能をそのまま活用でき、長期的なメンテナンスコストが最も低いです。

ユーザー様のご判断をお願いします。
```

#### オプション2: 一時的な回避策（次善策）
- デプロイワークフローを**残したまま**、WASM ビルドステップのみコメントアウト
- `# TODO: Fix WASM compilation - see issue #27` のようなコメントを追加
- ワークフローファイルは削除せず、将来の修正を容易にする

## 運用ルール

### ルール1: 削除前の3段階チェック

何かを削除する前に、以下を**すべて**確認：

1. **機能チェック**: この削除で失われる機能は何か？
2. **代替案チェック**: 削除以外の解決策を3つ以上検討したか？
3. **承認チェック**: ユーザーの明示的な承認を得たか？

### ルール2: アーキテクチャ変更の決定権

以下の変更は**Agent の独断で実施してはならない**（必ずユーザーに提案）：

- [ ] ビルドシステムの変更（Cargo.toml の target 変更、feature flag 追加など）
- [ ] CI/CD ワークフローの削除・大幅な変更
- [ ] パーサーやコア機能の実装方式変更
- [ ] 外部ライブラリの追加・削除（特にメインの依存関係）
- [ ] デプロイ方式の変更
- [ ] テストの削除・無効化（#[ignore] 含む）

### ルール3: 提案フォーマット

アーキテクチャに関わる提案を行う際は、以下の形式を使用：

```markdown
## 🚨 アーキテクチャ判断が必要です

### 問題
[何が起きているか]

### 根本原因
[技術的な詳細]

### 解決策オプション
#### オプションA: [名前]
- **実装方法**: ...
- **メリット**: ...
- **デメリット**: ...
- **工数**: ...
- **リスク**: ...

#### オプションB: [名前]
[同上]

#### オプションC: [名前]
[同上]

### 推奨案と理由
[どれを推奨するか、なぜか]

### 判断をお願いしたい点
- [ポイント1]
- [ポイント2]

このissueへの対処は、ユーザー様の判断をお待ちしています。
```

### ルール4: エラーメッセージの透明性

CI エラーが発生した場合：

1. **エラーの全文をそのままissueに記載**（要約しない）
2. **再現手順を明記**
3. **関連する環境情報を記載**（Rust version, target, 依存ライブラリのversion）
4. **過去のissueやPRを検索し、参照**

### ルール5: 段階的な修正

大きな問題に直面した場合：

1. **Phase 1**: エラーの完全な理解と文書化
2. **Phase 2**: 複数の解決策の調査と比較
3. **Phase 3**: ユーザーへの提案とフィードバック待ち
4. **Phase 4**: 承認された方法での実装

**Phase 3 を飛ばして Phase 4 に進むことは禁止**

## 自動マージポリシー

ユーザーは以下の理由により、自動マージを停止しました：

> 取り急ぎ、userはこのリポジトリにおける自動mergeをとりやめた。

### 自動マージが再開される条件（想定）

1. **Agent の判断精度向上**: 複数のPRで適切な判断が続くこと
2. **ガイドライン遵守の実績**: このドキュメントのルールが守られること
3. **エスカレーション機能の実装**: 重大な判断が必要な場合に自動停止する仕組み

### 現在のフロー

```
Issue created
  ↓
Agent analyzes and creates PR
  ↓
❗ STOP ❗ Manual review required
  ↓
User reviews PR
  ↓
User manually merges (if approved)
```

### 目指すべきフロー（将来）

```
Issue created
  ↓
Agent analyzes
  ↓
  ├─ Simple fix? → Create PR → Auto merge ✓
  ├─ Complex fix? → Create PR → Wait for review
  └─ Architecture change? → Create proposal Issue → Wait for decision
```

## チェックリスト: PR 作成前

PR を作成する前に、自己チェック：

- [ ] 既存の機能を削除していない（または削除が明示的に承認されている）
- [ ] copilot-instructions.md のガイドラインに従っている
- [ ] アーキテクチャ変更がある場合、ユーザーに提案済み
- [ ] テストがすべてpass している
- [ ] CI エラーを隠蔽していない（ignore, コメントアウト等）
- [ ] 代替案を検討し、ベストな解決策を選んでいる
- [ ] 変更の影響範囲を理解している
- [ ] ドキュメント（README, copilot-instructions等）を更新している

## 連絡・エスカレーション

### いつエスカレーションすべきか

以下の状況では**実装を止めて**、issue またはPRコメントでユーザーに相談：

1. ❗ **機能の削除が必要**
   - 「〇〇機能を削除する必要がありますが、よろしいでしょうか？」

2. ❗ **複数の解決策があり、判断が必要**
   - 「3つの解決策があります。どれを採用すべきかご判断ください」

3. ❗ **外部制約により実装不可能**
   - 「ライブラリXがY環境に対応していないため、代替案が必要です」

4. ❗ **工数が想定より大きい**
   - 「この修正には8時間以上かかる見込みです。実施してよろしいでしょうか？」

5. ❗ **セキュリティやパフォーマンスへの影響**
   - 「この変更により〇〇のリスクがあります。対処方針をご指示ください」

## まとめ

### 絶対にやってはいけないこと

1. 🚫 動作している機能・ワークフロー・テストの削除
2. 🚫 エラーの隠蔽（ignore, panic → Ok, コメントアウト等）
3. 🚫 アーキテクチャ変更をユーザー相談なしで実施
4. 🚫 copilot-instructions.md のガイドライン違反
5. 🚫 代替案を検討せずに最初の案を実装

### 常に心がけること

1. ✅ 複数の解決策を比較検討
2. ✅ 変更の影響範囲を明確に理解
3. ✅ ユーザーに判断を仰ぐべきポイントを識別
4. ✅ 将来の改善・修正の道を残す
5. ✅ 透明性のあるコミュニケーション

---

**このガイドラインは、AI Agent とユーザーの協働をスムーズにし、
高品質なコードを維持するためのものです。**
