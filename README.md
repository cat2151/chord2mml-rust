# chord2mml-rust

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/ðŸ‡¯ðŸ‡µ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/ðŸ‡ºðŸ‡¸-English-blue.svg" alt="English"></a>
</p>

A library and application for converting chord progressions to MML (Music Macro Language), written in Rust.

## Notes
- WIP
- Frequent breaking changes
- Intending to proceed with AI-driven development, minimizing user workload.
- Planning to develop an AI automation system for this purpose (or rather, using this as a repository for developing such a system).
- The following content is largely AI-generated, highly likely to contain errors, and may not align with user intent.

## Overview

This project is a complete rewrite of [chord2mml](https://github.com/cat2151/chord2mml), which was originally built with Peggy.js + JavaScript, now reimagined as **Rust + Tree-sitter**.

### Key Features

- **Tree-sitter Parser**: Robust and accurate syntax analysis
- **CST to AST Conversion**: Converts the CST (Concrete Syntax Tree) generated by Tree-sitter into an AST (Abstract Syntax Tree)
- **Pure Rust Native Application**: Specialized for text-to-text conversion
- **CLI Tool**: Directly usable from the command line
- **Library Crate**: Directly usable from Rust native applications

## Architecture

```
chord2mml-rust/
â”œâ”€â”€ tree-sitter-chord/   # Tree-sitter grammar definition
â”œâ”€â”€ chord2mml-core/      # Rust conversion core library (CSTâ†’ASTâ†’MML)
â””â”€â”€ chord2mml-cli/       # Command-line interface
```

### Data Flow

```
Input Text (e.g., "C-F-G-C")
    â†“
Tree-sitter Parser
    â†“
CST (Concrete Syntax Tree)
    â†“
AST Conversion
    â†“
AST (Abstract Syntax Tree)
    â†“
MML Generation
    â†“
Output MML (e.g., "c;e;g f;a;c g;b;d c;e;g")
```

### Components

1. **tree-sitter-chord**: Tree-sitter Grammar Definition
   - Syntax definition for chord notation (e.g., C, Dm, G7)
   - Support for chord progressions (e.g., C-F-G-C)

2. **chord2mml-core**: A Rust library for parsing chord progressions and converting them to MML
   - Syntax analysis using Tree-sitter
   - Conversion from CST (Concrete Syntax Tree) to AST (Abstract Syntax Tree)
   - Conversion from AST to MML
   - Usable from native applications

3. **chord2mml-cli**: Command-line tool
   - Text-to-text conversion interface
   - Supports input from standard in/arguments

## Demo

### CLI Tool

```bash
# Single chord
$ chord2mml "C"
c;e;g

# Chord progression
$ chord2mml "C-F-G-C"
c;e;g f;a;c g;b;d c;e;g

# Minor chord
$ chord2mml "Dm"
d;f;a

# Mixed progression
$ chord2mml "C-Dm-G-C"
c;e;g d;f;a g;b;d c;e;g
```

## Usage

### CLI Tool

```bash
# Build
cd chord2mml-cli
cargo build --release

# Run (from arguments)
chord2mml "C-F-G-C"

# Run (from standard input)
echo "C-F-G-C" | chord2mml

# Interactive mode
chord2mml
# Enter chord notation and press Enter
```

### As a Rust Library

```rust
use chord2mml_core::convert;

fn main() {
    // Single chord
    let chord = "C";
    let mml = convert(chord).unwrap();
    println!("MML: {}", mml); // "c;e;g"
    
    // Chord progression
    let progression = "C-F-G-C";
    let mml = convert(progression).unwrap();
    println!("MML: {}", mml); // "c;e;g f;a;c g;b;d c;e;g"
}
```

### How to Build

#### Rust Library and Core

```bash
cd chord2mml-core
cargo build --release
cargo test
```

#### CLI Tool

```bash
cd chord2mml-cli
cargo build --release
# The binary will be generated at ../target/release/chord2mml
```

#### Running Examples

```bash
cd chord2mml-core
cargo run --example basic
```

## Roadmap

### Phase 1: Basic Tree-sitter based implementation âœ…

- [x] Define Tree-sitter grammar
- [x] Basic chord conversion functionality (C â†’ c;e;g)
- [x] Support for chord progressions (C-F-G-C)
- [x] CSTâ†’ASTâ†’MML conversion pipeline
- [x] Implement CLI tool
- [x] Add comprehensive tests

### Phase 2: Porting original chord2mml tests

Port tests from the original [chord2mml](https://github.com/cat2151/chord2mml) repository to comprehensively support the following chords:

**Current Implementation Status**: Major and minor chords are fully implemented. Other chord types are only recognized by the parser, with MML conversion not yet implemented.

#### Major Chords
- [x] C (C-E-G)
- [ ] C6 (C-E-G-A)
- [ ] CM7, Cmaj7 (C-E-G-B) *Parser support only, MML conversion not implemented
- [ ] Cadd9 (C-E-G-D)
- [ ] C69 (C-E-G-A-D)

#### Minor Chords
- [x] Cm (C-Eb-G)
- [ ] Cm6 (C-Eb-G-A)
- [ ] Cm7 (C-Eb-G-Bb)
- [ ] CmM7, Cm(maj7) (C-Eb-G-B)
- [ ] Cm7-5, Cm7(b5) (C-Eb-Gb-Bb)

#### Seventh Chords
- [ ] C7 (C-E-G-Bb) *Parser support only, MML conversion not implemented
- [ ] C7sus4 (C-F-G-Bb)
- [ ] C7-5, C7(b5) (C-E-Gb-Bb)
- [ ] C7+5, C7(#5), Caug7 (C-E-G#-Bb)
- [ ] C7-9, C7(b9) (C-E-G-Bb-Db)
- [ ] C7+9, C7(#9) (C-E-G-Bb-D#)

#### Diminished and Augmented Chords
- [ ] Cdim, Cdim7 (C-Eb-Gb-A) *Parser support only, MML conversion not implemented
- [ ] Caug, C+, C(#5) (C-E-G#) *Parser support only, MML conversion not implemented

#### Suspended Chords
- [ ] Csus4 (C-F-G) *Parser support only, MML conversion not implemented
- [ ] Csus2 (C-D-G) *Parser support only, MML conversion not implemented

#### Inversions and Bass Notes
- [ ] C/E (First inversion: E-G-C) *Parser support only, MML conversion not implemented
- [ ] C/G (Second inversion: G-C-E) *Parser support only, MML conversion not implemented
- [ ] C/D (On-chord: D-C-E-G) *Parser support only, MML conversion not implemented

#### Other Chords
- [ ] 9th, 11th, 13th chords
- [ ] Tension notes
- [ ] Complex combinations of accidentals

#### Feature Enhancements
- [ ] Octave specification
- [ ] Rhythm and note length specification
- [x] Continuous input of multiple chords (chord progression)
- [ ] Automatic generation of chord progression patterns

### Phase 3: Advanced Features and Integration

- [ ] Support for more complex chord progressions
- [ ] Complete implementation of all chord types
- [ ] Re-implement WASM support (if necessary)
- [ ] Integration with tonejs-mml-to-json and tonejs-json-sequencer (audio playback functionality)
- [ ] Performance improvements
- [ ] Enhanced error handling
- [ ] Documentation improvements

## Development Policy

### Differences from original chord2mml

| Item | chord2mml (Old) | chord2mml-rust (New) |
|------|---------------|-------------------|
| Parser | Peggy.js | Tree-sitter |
| Language | JavaScript/TypeScript | Rust |
| Runtime Environment | Browser-only | Native (CLI) |
| Conversion Flow | PEG â†’ AST â†’ MML | Tree-sitter â†’ CST â†’ AST â†’ MML |
| Library Usage | Difficult | Easy (Rust Crate) |

### Design Philosophy

1. **Simplicity**: Avoid complexity, prioritize maintainability
2. **Type Safety**: Leverage Rust's powerful type system
3. **Test-Driven**: Comprehensive test coverage
4. **Performance**: Utilize Rust's speed for conversions

## Target Platforms

- **Rust Library**: All Rust supported environments
- **CLI Tool**: Linux, macOS, Windows

## Technology Stack

- **Rust**: 1.70 or later
- **Tree-sitter**: Syntax parsing engine
- **tree-sitter-cli**: Grammar generation tool

### Future Introductions

- **WASM**: Browser execution support (if necessary)
- **tonejs-mml-to-json**: Advanced MML parsing
- **tonejs-json-sequencer**: More advanced audio playback

## Testing

```bash
# Test Rust core
cd chord2mml-core
cargo test

# Test all
cargo test --all

# Run examples
cd chord2mml-core
cargo run --example basic
```

## Build Requirements

- Rust 1.70 or later
- Node.js 18 or later (for tree-sitter-cli)
- tree-sitter-cli (for grammar generation)

## License

MIT License

## Related Projects

- [chord2mml](https://github.com/cat2151/chord2mml) - Original JavaScript version
- [tonejs-mml-to-json](https://github.com/cat2151/tonejs-mml-to-json) - MML parsing library
- [tonejs-json-sequencer](https://github.com/cat2151/tonejs-json-sequencer) - Audio playback library

## Contributing

Issues and Pull Requests are welcome.

## Author

cat2151

## Reference Links

- [Original chord2mml](https://github.com/cat2151/chord2mml) - Original JavaScript version
- [Tree-sitter](https://tree-sitter.github.io/tree-sitter/) - Syntax parsing library
- [EXAMPLES.md](EXAMPLES.md) - More detailed usage examples and architecture description