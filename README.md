# chord2mml-rust

<p align="left">
  <a href="README.ja.md"><img src="https://img.shields.io/badge/ðŸ‡¯ðŸ‡µ-Japanese-red.svg" alt="Japanese"></a>
  <a href="README.md"><img src="https://img.shields.io/badge/ðŸ‡ºðŸ‡¸-English-blue.svg" alt="English"></a>
</p>

A library and application for converting chord progressions to MML (Music Macro Language), written in Rust.

## Attention
- WIP
- Frequent breaking changes
- Plans to proceed with AI automation to minimize user workload.
- Intend to develop an AI automation system for this purpose (or rather, use this repository as a development ground for an AI automation system).
- The following content is mostly AI-generated and likely contains errors or deviates from the user's intent.

## Overview

This project is a complete reimplementation of [chord2mml](https://github.com/cat2151/chord2mml), which was originally built with Peggy.js + JavaScript, now using **Rust + Tree-sitter**.

### Key Features

- **Tree-sitter Parser**: Robust and accurate syntax analysis.
- **CST to AST Conversion**: Converts the Concrete Syntax Tree (CST) generated by Tree-sitter into an Abstract Syntax Tree (AST).
- **Pure Rust Native Application**: Specializes in text-to-text conversion.
- **CLI Tool**: Directly usable from the command line.
- **Library Crate**: Directly usable from Rust native applications.

## Architecture

```
chord2mml-rust/
â”œâ”€â”€ tree-sitter-chord/   # Tree-sitter grammar definition
â”œâ”€â”€ chord2mml-core/      # Rust core conversion library (CSTâ†’ASTâ†’MML)
â””â”€â”€ chord2mml-cli/       # Command-line interface
```

### Data Flow

```
Input Text (e.g., "C-F-G-C")
    â†“
Tree-sitter Parser
    â†“
CST (Concrete Syntax Tree)
    â†“
AST Conversion
    â†“
AST (Abstract Syntax Tree)
    â†“
MML Generation
    â†“
Output MML (e.g., "'c;e;g' 'f;a;c' 'g;b;d' 'c;e;g'")
```

### Components

1.  **tree-sitter-chord**: Tree-sitter Grammar Definition
    -   Syntax definition for chord notation (C, Dm, G7, etc.).
    -   Support for chord progressions (C-F-G-C, etc.).

2.  **chord2mml-core**: Rust library for parsing chord progressions and converting them to MML.
    -   Syntax analysis using Tree-sitter.
    -   Conversion from Concrete Syntax Tree (CST) to Abstract Syntax Tree (AST).
    -   Conversion from AST to MML.
    -   Usable from native applications.

3.  **chord2mml-cli**: Command-line tool
    -   Text-to-text conversion interface.
    -   Supports input from standard input/arguments.

## Demo

### CLI Tool

```bash
# Single chord
$ chord2mml "C"
'c;e;g'

# Chord progression
$ chord2mml "C-F-G-C"
'c;e;g' 'f;a;c' 'g;b;d' 'c;e;g'

# Minor chord
$ chord2mml "Dm"
'd;f;a'

# Mixed progression
$ chord2mml "C-Dm-G-C"
'c;e;g' 'd;f;a' 'g;b;d' 'c;e;g'
```

## How to Use

### CLI Tool

```bash
# Build
cd chord2mml-cli
cargo build --release

# Run (from arguments)
chord2mml "C-F-G-C"

# Run (from standard input)
echo "C-F-G-C" | chord2mml

# Interactive mode
chord2mml
# Enter chord notation and press Enter
```

### As a Rust Library

```rust
use chord2mml_core::convert;

fn main() {
    // Single chord
    let chord = "C";
    let mml = convert(chord).unwrap();
    println!("MML: {}", mml); // "'c;e;g'"
    
    // Chord progression
    let progression = "C-F-G-C";
    let mml = convert(progression).unwrap();
    println!("MML: {}", mml); // "'c;e;g' 'f;a;c' 'g;b;d' 'c;e;g'"
}
```

### Build Instructions

#### Rust Library and Core

```bash
cd chord2mml-core
cargo build --release
cargo test
```

#### CLI Tool

```bash
cd chord2mml-cli
cargo build --release
# The binary will be generated at ../target/release/chord2mml
```

#### Run Examples

```bash
cd chord2mml-core
cargo run --example basic
```

## Roadmap

### Phase 1: Tree-sitter based basic implementation âœ…

- [x] Tree-sitter grammar definition
- [x] Basic chord conversion functionality (C â†’ c;e;g)
- [x] Chord progression support (C-F-G-C)
- [x] CSTâ†’ASTâ†’MML conversion pipeline
- [x] CLI tool implementation
- [x] Add comprehensive tests

### Phase 2: Porting original chord2mml tests

Port the tests from the original [chord2mml](https://github.com/cat2151/chord2mml) repository to comprehensively support the following chords:

**Current implementation status**: Major and minor chords are fully implemented. Other chord types are recognized by the parser only, with MML conversion not yet implemented.

#### Major Chords
- [x] C (C, E, G)
- [ ] C6 (C, E, G, A)
- [ ] CM7, Cmaj7 (C, E, G, B) â€»Parser only, MML conversion not implemented
- [ ] Cadd9 (C, E, G, D)

#### Minor Chords
- [x] Cm (C, Eb, G)
- [ ] Cm7 (C, Eb, G, Bb)

#### Seventh Chords
- [ ] C7 (C, E, G, Bb) â€»Parser only, MML conversion not implemented
- [ ] C7sus4 (C, F, G, Bb)

#### Diminished / Augmented Chords
- [ ] Cdim (C, Eb, Gb) â€»Parser only, MML conversion not implemented
- [ ] Caug, C+, C(#5) (C, E, G#) â€»Parser only, MML conversion not implemented

#### Suspended Chords
- [ ] Csus4 (C, F, G) â€»Parser only, MML conversion not implemented
- [ ] Csus2 (C, D, G) â€»Parser only, MML conversion not implemented

#### Inversions and Bass Specification
- [ ] C/E (First inversion: E, G, C) â€»Parser only, MML conversion not implemented
- [ ] C/G (Second inversion: G, C, E) â€»Parser only, MML conversion not implemented
- [ ] C/D (On-chord: D, C, E, G) â€»Parser only, MML conversion not implemented

#### Feature Enhancements
- [ ] Octave specification
- [ ] Rhythm and duration specification
- [x] Continuous input of multiple chords (chord progressions)

### Phase 3: Advanced Features and Integration

- [ ] Support for more complex chord progressions
- [ ] Complete implementation of all chord types
- [ ] Reimplementation of WASM support (if necessary)
- [ ] Performance improvements
- [ ] Enhanced error handling
- [ ] Documentation improvements

## Development Policy

### Differences from original chord2mml

| Item            | chord2mml (Old)     | chord2mml-rust (New) |
|-----------------|---------------------|----------------------|
| Parser          | Peggy.js            | Tree-sitter          |
| Language        | JavaScript/TypeScript | Rust                 |
| Runtime Environment | Browser-specific    | Native (CLI)         |
| Conversion Flow | PEG â†’ AST â†’ MML     | Tree-sitter â†’ CST â†’ AST â†’ MML |
| Library Usage   | Difficult           | Easy (Rust crate)    |

### Design Philosophy

1.  **Simplicity**: Avoid complexity, prioritize maintainability.
2.  **Type Safety**: Leverage Rust's powerful type system.
3.  **Test-Driven Development**: Comprehensive test coverage.
4.  **Performance**: Utilize Rust's high speed for conversion.

## Target Platforms

- **Rust Library**: All Rust supported environments
- **CLI Tool**: Linux, macOS, Windows

## Technology Stack

- **Rust**: 1.70 or later
- **Tree-sitter**: Parsing engine
- **tree-sitter-cli**: Grammar generation tool

## Testing

```bash
# Test Rust core
cd chord2mml-core
cargo test

# Test all
cargo test --all

# Run examples
cd chord2mml-core
cargo run --example basic
```

## Build Requirements

- Rust 1.70 or later
- Node.js 18 or later (for tree-sitter-cli)
- tree-sitter-cli (for grammar generation)

## License

MIT License

## Related Projects

- [chord2mml](https://github.com/cat2151/chord2mml) - Original JavaScript version
- [tonejs-mml-to-json](https://github.com/cat2151/tonejs-mml-to-json) - MML parsing library
- [tonejs-json-sequencer](https://github.com/cat2151/tonejs-json-sequencer) - Audio playback library

## Contributing

Issues and Pull Requests are welcome.

## Author

cat2151

## Reference Links

- [Original chord2mml](https://github.com/cat2151/chord2mml) - Original JavaScript version
- [Tree-sitter](https://tree-sitter.github.io/tree-sitter/) - Syntax parsing library
- [EXAMPLES.md](EXAMPLES.md) - More detailed usage examples and architecture explanation